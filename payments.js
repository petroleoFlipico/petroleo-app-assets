"use strict";(()=>{var F=document.querySelector("#cart-button"),te=document.querySelector("#added-to-cart"),H={};async function w(){try{let t=await(await fetch("https://petroleo-app.onrender.com/api/cart",{credentials:"include"})).json();if(!Array.isArray(t))throw new Error("Received data is not an array");return t}catch(e){return console.error("Failed to fetch cart items:",e),[]}}async function z(){F?.classList.remove("hide");let e=document.querySelector(".state-default"),t=document.querySelector(".state-empty"),o=document.querySelector(".state-error");try{let a=await w(),l=a.reduce((n,s)=>n+s.price*s.quantity,0),r=document.getElementById("cart-total");r&&(r.style.display="block",r.textContent=`${l.toFixed(2)} z\u0142 + VAT`);let i=document.getElementById("cart-quantity");if(i){let n=a.reduce((s,p)=>s+p.quantity,0);i.textContent=n.toString()}e&&t&&o&&(a.length>0?(t.style.display="none",o.style.display="none",e.style.display="block"):(e.style.display="none",o.style.display="none",t.style.display="flex")),await O(a)}catch(a){console.error("Failed to update cart UI:",a),e&&t&&o&&(t.style.display="none",e.style.display="none",o.style.display="flex")}}async function j(e,t=null){try{let o=t==="null"?null:t,a=await fetch(`https://petroleo-app.onrender.com/api/cart/${e}`,{method:"DELETE",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({variant:o})});if(!a.ok)throw new Error(`Failed to remove item: ${a.statusText}`);window.dataLayer.push({ecommerce:null}),window.dataLayer.push({event:"remove_from_cart",ecommerce:{items:[{item_id:e,item_name:e,affiliation:"Konferencja App"}]}}),await z()}catch(o){console.error("Failed to remove item from cart:",o)}}async function g(e,t,o=null){try{let a=await fetch(`https://petroleo-app.onrender.com/api/cart/${e}`,{method:"PUT",headers:{"Content-Type":"application/json"},credentials:"include",body:JSON.stringify({variant:o==="null"?null:o,quantity:t,attendeeName:H[e]||[]})});if(!a.ok)throw new Error(`Failed to update item quantity: ${a.statusText}`);window.location.href.includes("koszyk")||await z()}catch(a){console.error("Failed to update item quantity:",a)}}function _(){document.addEventListener("change",async e=>{let t=e.target;if(!t.classList.contains("is-quantity"))return;let o=parseInt(t.value,10),a=t.closest(".cart-item"),l=a?.querySelector(".deletebutton")?.getAttribute("data-item-id"),r=a?.querySelector(".deletebutton")?.getAttribute("data-variant")||null;l&&o>0&&await g(l,o,r)})}async function O(e){let t=document.querySelector(".cart-list");if(!t)return;t.innerHTML="",e.forEach((a,l)=>{let r=document.createElement("div");r.className="cart-item",r.innerHTML=`
            <div class="cart-product-info" style="white-space: nowrap">
                <div class="margin-bottom margin-custom5">    
                    <span class="text-weight-semibold text-style-2lines" style="text-wrap: initial">${a.ticketType.toUpperCase()}</span>
                </div>
                <div class="cart-product-parameter" style="display: ${a.variant!==null?"flex":"none"}">
                    <div class="display-inline">Wariant:</div>
                    <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${a.variant}</div>
                </div>
                
                <div class="cart-product-parameter">
                    <div class="display-inline">Cena:</div>
                    <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${a.price} z\u0142 + VAT</div>
                </div>

                <div class="cart-product-parameter">
                    <div class="display-inline">Ilo\u015B\u0107:</div>
                    <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${a.quantity}</div>
                </div>
            </div>
            <div class="card-product-form w-form">
                <input class="form_input is-quantity w-input" data-input="quantity" maxlength="256" value="${a.quantity}" type="number">
            </div>
            <button class="button-6 deletebutton" data-item-id="${a.id}" data-variant="${a.variant}">
                <div class="icon-1x1-xsmall">
                    <svg xmlns="http://www.w3.org/2000/svg" width="100%" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tabler icons-tabler-outline icon-tabler-x">
                        <path stroke="none" d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M18 6l-12 12"></path>
                        <path d="M6 6l12 12"></path>
                    </svg>
                </div>
            </button>
        `,t.appendChild(r)}),_(),document.querySelectorAll(".deletebutton").forEach(a=>{a.addEventListener("click",async l=>{let r=l.currentTarget,i=r.getAttribute("data-item-id"),n=r.getAttribute("data-variant")||null;i?await j(i,n):console.error("Failed to remove item from cart: missing item ID")})})}function k(e,t){let o=document.createElement("select");o.classList.add("form_input"),o.dataset.input="variant",o.setAttribute("validate","true");let a=document.createElement("option");return a.value="",a.disabled=!0,a.selected=!0,a.textContent=e,o.appendChild(a),t.forEach(({value:l,label:r})=>{let i=document.createElement("option");i.value=l,i.textContent=r,o.appendChild(i)}),D(o),o}function D(e){e.style.appearance="none",e.style.setProperty("-webkit-appearance","none"),e.style.setProperty("-moz-appearance","none"),e.style.paddingRight="2.5rem",e.style.boxSizing="border-box";let t=`<svg width="10" height="6" viewBox="0 0 10 6"
      xmlns="http://www.w3.org/2000/svg"><path d="M0 0l5 6 5-6z" fill="#333"/></svg>`;e.style.backgroundImage=`url("data:image/svg+xml;charset=UTF-8,${encodeURIComponent(t)}")`,e.style.backgroundRepeat="no-repeat",e.style.backgroundPosition="right 1rem center"}function I(e,t){let o=[{value:"Rynek polski",label:"Rynek polski"},{value:"Rynek zagraniczny",label:"Rynek zagraniczny"}],a=[{value:"Szczecin",label:"Szczecin"},{value:"Gda\u0144sk",label:"Gda\u0144sk"},{value:"Bydgoszcz",label:"Bydgoszcz"},{value:"Pozna\u0144",label:"Pozna\u0144"}];document.querySelectorAll(".order-item-list").forEach((r,i)=>{r&&(r.innerHTML="",e.forEach(n=>{let s=document.createElement("div");if(s.className="order-item",s.innerHTML=`
                <span class="text-weight-semibold text-style-2lines" style="text-wrap: initial">${n.ticketType.toUpperCase()}</span>
            `,t===1&&i===0){let p=n.ticketType;if(p==="VIP"||p==="Premium"||p==="Standard"||p==="Objazd\xF3wka Standard"||p==="Objazd\xF3wka Premium"){let d=document.createElement("div");if(d.className="cart-product-parameter",n.variant!==null)d.innerHTML=`
                <div class="display-inline">Wariant:</div>
                <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${n.variant}</div>
            `;else{d.style.marginBottom="0.5rem";let u=null;p==="VIP"?u=k("Wybierz rodzaj warsztat\xF3w",o):(p==="Objazd\xF3wka Standard"||p==="Objazd\xF3wka Premium")&&(u=k("Wybierz miasto",a)),u&&(u.value=n.variant||"",d.innerHTML='<div class="display-inline">Wariant:</div>',d.appendChild(u),u.addEventListener("change",async()=>{n.variant=u.value,await g(n.id,n.quantity,n.variant),u.disabled=!0,u.style.cursor="not-allowed"}))}s.appendChild(d)}let c=document.createElement("div");c.className="cart-product-parameter",Array.isArray(n.attendeeName)||(n.attendeeName=[]);let m=()=>{c.innerHTML="";for(let d=0;d<n.quantity;d++){let u=document.createElement("input");u.className="form_input w-input attendee-name",u.type="text",u.placeholder=`Imi\u0119 i nazwisko #${d+1}`,u.required=!0,u.dataset.ticketId=n.id,u.dataset.attendeeIndex=`${d}`,u.value=n.attendeeName?.[d]||"",u.addEventListener("input",()=>{n.attendeeName||(n.attendeeName=[]),n.attendeeName[d]=u.value,H[n.id]=[...n.attendeeName]}),c.appendChild(u)}};m(),s.appendChild(c);let y=document.createElement("div");y.className="cart-product-parameter",y.innerHTML=`
        <div class="display-inline">Ilo\u015B\u0107:</div>
        <input class="form_input is-quantity w-input" data-input="quantity" maxlength="256" value="${n.quantity}" type="number" min="1">
    `;let v=document.createElement("div");v.className="cart-product-parameter",v.innerHTML=`
        <div class="display-inline">Cena:</div>
        <div class="display-inline text-weight-semibold text-color-brand">${(n.price*n.quantity).toFixed(2)} z\u0142 + VAT</div>
    `;let T=y.querySelector('input[data-input="quantity"]');T?.addEventListener("input",async()=>{let d=parseInt(T.value,10);if(d>0){if(n.quantity=d,!n.attendeeName||n.attendeeName.length>d)n.attendeeName&&(n.attendeeName=n.attendeeName.slice(0,d));else for(;n.attendeeName.length<d;)n.attendeeName.push("");m(),await g(n.id,d,n.variant),B(v,n.price,d)}}),s.appendChild(y),s.appendChild(v)}else t===2&&i===1&&((n.attendeeName||[]).forEach((c,m)=>{s.innerHTML+=`
            <div class="cart-product-parameter">
                <div class="display-inline" style="white-space: nowrap">Imi\u0119 i nazwisko #${m+1}:</div>
                <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${c}</div>
            </div>
        `}),n.variant!==null&&(s.innerHTML+=`
            <div class="cart-product-parameter">
                <div class="display-inline">Wariant:</div>
                <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${n.variant}</div>
            </div>
        `),s.innerHTML+=`
        <div class="cart-product-parameter">
            <div class="display-inline">Cena:</div>
            <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${n.price} z\u0142 + VAT</div>
        </div>
        <div class="cart-product-parameter">
            <div class="display-inline">Ilo\u015B\u0107:</div>
            <div class="display-inline text-weight-semibold text-color-brand">&nbsp;${n.quantity}</div>
        </div>
    `);r.appendChild(s)}))})}function B(e,t,o){let a=e.querySelector(".text-weight-semibold.text-color-brand");a&&(a.textContent=`${(t*o).toFixed(2)} z\u0142 + VAT`)}async function N(){try{return(await(await fetch("https://petroleo-app.onrender.com/api/session-id",{method:"GET",headers:{"Content-Type":"application/json"},credentials:"include"})).json()).sessionID}catch(e){return console.error("B\u0142\u0105d podczas pobierania ID sesji:",e),null}}function V(){let e=document.querySelectorAll('select[data-input="variant"][validate="true"]'),t=!0;return e.forEach(o=>{o.value===""&&(alert("Prosz\u0119 wybra\u0107 wariant warsztat\xF3w przed przej\u015Bciem dalej."),t=!1)}),t}var R=()=>{let e=document.querySelector("#Email")?.value||"",t=document.querySelector("#wf-ecom-shipping-name")?.value||"",o=document.querySelector("#nip")?.value||"",a=document.querySelector("#Telefon")?.value||"",l=document.querySelector("#DodatkoweInformacje")?.value||"",r=document.querySelector("#nazwa-firmy")?.value||"",i=document.querySelector("#Adres-Firmy")?.value||"",n=document.querySelector("#address-line1")?.value||"",s=document.querySelector("#address-line2")?.value||"",p=document.querySelector("#city")?.value||"",c=document.querySelector("#state")?.value||"",m=document.querySelector("#postal-code")?.value||"",y=document.querySelector("#country")?.value||"PL";return{email:e,name:t,nip:o,phone:a,additionalInfo:l,companyName:r,companyAddress:i,addressLine1:n,addressLine2:s,city:p,state:c,postalCode:m,country:y}},W=e=>/^\d{10}$/.test(e),L=(e,t)=>!e||e.value.trim()===""?(alert(`Prosz\u0119 uzupe\u0142ni\u0107 pole: ${t}.`),!1):!0,U=()=>{let e=document.querySelector("#Company"),t=document.querySelector("#nip"),o=document.querySelector("#nazwa-firmy"),a=document.querySelector("#Adres-Firmy");return e?.checked?(t?.value?W(t.value.trim()):!0)?L(t,"NIP")&&L(o,"Nazwa firmy")&&L(a,"Adres firmy"):(alert("Podany NIP jest niepoprawny."),!1):!0},K=()=>{if(!U())return!1;let o=document.querySelector('div[data-step="1"]')?.querySelectorAll("input[required], select[required]");if(!Array.from(o||[]).every(i=>i.value.trim()!==""))return alert("Prosz\u0119 uzupe\u0142ni\u0107 wszystkie wymagane pola."),!1;if(document.querySelector("#is-items")?.value!=="true")return alert("Koszyk musi zawiera\u0107 przedmioty."),!1;let r=document.querySelectorAll("input.attendee-name");for(let i of r)if(!i.value.trim())return alert("Prosz\u0119 wpisa\u0107 imi\u0119 i nazwisko dla ka\u017Cdego biletu."),!1;return!0},J=()=>{let e=document.querySelector('div[data-step="1"]'),t=document.querySelector("#is-items");if(t&&(t.value=String(!0)),!e)return;e.querySelectorAll("input[required], select[required]").forEach(l=>{l.addEventListener("input",b)}),e.querySelectorAll("input.attendee-name").forEach(l=>{l.addEventListener("input",b)}),t?.addEventListener("input",b),b()},Q=(e,t,o,a)=>{let l=document.querySelector(".products-cost");l&&(l.textContent=`${e.toFixed(2)} z\u0142 + VAT`);let r=document.querySelector(".coupon-amount");r&&r.parentElement&&(a>0?(r.parentElement.style.display="block",r.textContent=`${a.toFixed(2)} z\u0142`):r.parentElement.style.display="none");let i=document.querySelector(".tax");i&&(i.textContent=`${t.toFixed(2)} z\u0142`);let n=document.querySelector(".total-cost");n&&(n.textContent=`${o.toFixed(2)} z\u0142`)},S=(e,t)=>(e.reduce((a,l)=>a+l.price*l.quantity,0)-t).toFixed(2),G=document.querySelector('a[data-form="next-btn"]'),A=document.querySelector('div[data-step="1"]'),P=document.querySelector('div[data-step="2"]'),x=document.querySelector("#Company"),f=document.querySelector(".company-info");f&&(f.style.display="none");var $=f?.querySelectorAll("input"),q=document.querySelector("#nip");q?.removeAttribute("required");x&&f&&$&&x.addEventListener("change",()=>{x.checked?(f.style.display="flex",q?.setAttribute("required","true")):(f.style.display="none",$.forEach(e=>e.value=""),q?.removeAttribute("required"))});var b=()=>{let e=document.querySelector('a[data-form="next-btn"]'),t=document.querySelector('div[data-step="1"]'),o=document.querySelector("#is-items");if(!t||!e||!o)return;let a=t.querySelectorAll("input[required], select[required]"),l=t.querySelectorAll("input.attendee-name"),r=[],i=[];a.forEach(m=>{if(m.value.trim()===""){let y=m.closest(".form-group")?.querySelector("label")?.textContent?.trim()||m.name||m.id;r.push(y)}}),l.forEach((m,y)=>{m.value.trim()===""&&i.push(`Bilet #${y+1}`)});let n=o.value==="true",s=r.length===0,p=i.length===0,c=s&&p&&n;console.clear(),c?console.log("\u2705 Wszystkie dane s\u0105 poprawne. Przycisk \u201EDalej\u201D dost\u0119pny."):(console.group("\u{1F512} Przycisk \u201EDalej\u201D zablokowany \u2013 brakuje:"),n||console.warn('\u{1F6D2} Koszyk jest pusty (isItemsInput !== "true")'),r.length>0&&console.warn("\u{1F4C4} Pola wymagane:",r),i.length>0&&console.warn("\u{1F465} Imiona i nazwiska brakuj\u0105ce:",i),console.groupEnd()),e.disabled=!c,e.style.cursor=c?"pointer":"not-allowed",e.style.opacity=c?"1":"0.5",e.style.pointerEvents=c?"auto":"none",e.style.display=c?"block":"none"},Y=async()=>{A&&P?(A.style.display="none",P.style.display="flex",window.scrollTo({top:0,behavior:"smooth"})):console.error("One of the step wrappers is not found.")},Z=async(e,t,o,a,l,r,i)=>{try{return console.log("Sending to backend:",l),await(await fetch("https://petroleo-app.onrender.com/api/create-payment-intent",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({products_cost:Math.round(e*100),tax_cost:Math.round(t*100),total_amount:Math.round(o*100),coupon_amount:Math.round(a*100),currency:"PLN",items:l.flatMap(s=>Array.from({length:s.quantity},(p,c)=>({id:s.id,ticketType:s.ticketType,quantity:1,price:s.price,variant:s.variant||null,attendeeName:s.attendeeName?.[c]||""}))),customer_email:r.email,customer_name:r.name,nip:r.nip,phone:r.phone,additional_info:r.additionalInfo,company_name:r.companyName,company_address:r.companyAddress,sessionID:i})})).json()}catch(n){return console.error("Error creating payment intent:",n),null}};async function X(e){let t=document.querySelector('div[data-output="nip"]'),o=document.querySelector('div[data-output="company-name"]'),a=document.querySelector('div[data-output="company-address"]');e.nip!==""&&t&&o&&a?(t.textContent=e.nip,o.textContent=e.companyName,a.textContent=e.companyAddress):e.nip===""&&t&&t.parentElement&&(t.parentElement.style.display="none")}var ee=async()=>{let e=window.Stripe?.("pk_test_51RdVZ203pAaMeUO4sSCM4gxQJo3oXr2dMCS6BZoCKeVsYJFaFxI9mQqnVS3mCtCO8Yi9Q0KUK53v3Kn8wwlnAEpm00tnDJLG47",{stripeAccount:"acct_"});if(!e){console.error("Stripe nie zosta\u0142o zainicjalizowane.");return}let t=document.querySelector('[data-element="payment_form"]');if(t)t.addEventListener("keydown",r=>{r.key==="Enter"&&r.preventDefault()});else{console.error("Payment form element could not be found. Ensure that the form has the correct data-element attribute.");return}let o=await w();if(o.length===0&&window.location.pathname.includes("/koszyk")){alert("Tw\xF3j koszyk jest pusty. Dodaj przedmioty do koszyka."),window.location.href="/";return}J();let a=async r=>{try{return await(await fetch("https://petroleo-app.onrender.com/api/validate-coupon",{credentials:"include",method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({couponCode:r})})).json()}catch(i){return console.error("Error checking coupon:",i),{isValid:!1,discountType:null,amount:0}}},l=0;document.getElementById("apply-coupon")?.addEventListener("click",async()=>{let r=document.getElementById("coupon-code"),i=document.getElementById("coupon-feedback");if(!r||!i){console.error("Nie znaleziono elementu formularza kuponu.");return}let n=r.value.trim(),{isValid:s,discountType:p,amount:c}=await a(n);if(!s){i.textContent="Nieprawid\u0142owy kupon.",i.style.display="block",i.style.color="#b42318",i.classList.remove("hide");return}let m=p==="fixed"?`Zni\u017Cka: ${(c/100).toFixed(2)} z\u0142`:`Zni\u017Cka: ${c}%`;i.innerHTML=`Kupon zosta\u0142 dodany. ${m}<br/>Cena zostanie zrabatowana w kolejnym kroku.`,i.style.display="block",i.style.color="#027a48",i.classList.remove("hide");let y=S(o,0);l=p==="percentage"?Number(y)*(c/100):c/100}),I(o,1),G?.addEventListener("click",async()=>{if(!K()||!V())return;let r=R();await X(r);let i=await w();I(i,2);let n=S(i,0),s=S(i,l),p=(Number(s)*.23).toFixed(2);if(s=(Number(s)*1.23).toFixed(2),Number(s)<=2){alert("Suma produkt\xF3w w koszyku musi wynosi\u0107 wi\u0119cej ni\u017C 2.00 z\u0142, aby kontynuowa\u0107.");return}Q(Number(n),Number(p),Number(s),Number(l)),await Y();let c=await N(),m=await Z(Number(n),Number(p),Number(s),Number(l),i,{...r,address_line1:r.addressLine1,address_line2:r.addressLine2,city:r.city,state:r.state,postal_code:r.postalCode,country:r.country},c);if(!m){console.error("Payment intent is missing.");return}let y=document.querySelector('[data-element="stripe"]');if(!y){console.error("Stripe element could not be found. Ensure that the element has the correct data-element attribute.");return}let v=e.elements({clientSecret:m.client_secret});v.create("payment").mount(y);let d="https://petroleo-wf-dev.webflow.io/potwierdzenie-zamowienia";t.addEventListener("submit",async u=>{u.preventDefault(),u.stopPropagation(),await v.submit();let C=await e.confirmPayment({elements:v,clientSecret:m.client_secret,redirect:"always",confirmParams:{return_url:d}}),h=document.querySelector(".w-form-done"),E=document.querySelector(".w-form-fail"),M=document.querySelector(".container-medium");C.error?(E&&(E.textContent=`P\u0142atno\u015B\u0107 nieudana: ${C.error.message}`,E.style.display="block"),h&&(h.style.display="none")):(h&&(h.textContent="P\u0142atno\u015B\u0107 zako\u0144czona sukcesem!",h.style.display="block"),E&&(E.style.display="none"),M&&(M.style.display="none"))},!0)})};document.addEventListener("DOMContentLoaded",ee);})();
